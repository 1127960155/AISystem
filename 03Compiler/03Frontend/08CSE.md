# 公共表达式消除

## 公共表达式消除概述

公共表达式消除（Common Subexpression Elimination，简称CSE）是编译器优化中的一种技术，旨在消除程序中重复计算的公共表达式，从而减少计算量和提高执行效率。

在程序中，有时会出现多个地方使用相同的表达式进行计算，虽然这些表达式的结果是相同的，但是由于重复计算，会增加不必要的计算开销。公共表达式消除的目标就是识别出这些重复的计算，并将其提取出来，只计算一次，然后将结果保存起来供后续使用。

以下是一个简单的公共子表达式：

- a = b * c + g
- d = b * c + e

可以观察到b * c 是两项表达式中的公共子表达式。如果计算这个子表达式并将其存储起来的开销小于重复计算这个子表达式的开销，则能够将以上代码转化成以下代码:

- temp = b * c
- a = temp + g  
- d = temp + e

公共子表达式需要满足以下几个准则：

1.执行这项优化的可能性基于表达式的定义可达性。当一下条件成立，则一个表达式b * c在程序的某个点P被定义为是可达的：

- 从初始节点到点p的每条路径在到达p之前计算过b*c
- b*c 被计算后，无论b或者c到达p以前都没有被重新赋值过

当b 或者 c发生变化后，编译器再次遇到b * c这个操作时，会将 b * c (操作B)认定为另一个操作，与之前的b * c（操作A）不是同一个操作。所以准确来说操作A的替换区域将会覆盖到操作B出现时任何一个节点，比可达区域多了一部分，虽然这一部分不会出现操作A。只要在替换区域内的全部操作A都可能会被替换。至于是否被替换还需要下面的准则。

2.由编译器计算的成本效益分析可以判断出，重复计算该表达式的开销是否大于存储该表达式的计算结果，并且这个分析也要将寄存器等因素考虑在内。编译器会判断消除某个公共表达式会不会产生负优化，如果负优化则不对这个公共表达式进行消除。

具体的公共表达式消除过程如下：

- 分析程序的表达式，识别出具有相同运算符和操作数的表达式。
- 对于相同的表达式，将其提取出来，计算一次，并将结果存储在一个临时变量中。
- 在原来的位置，将该表达式替换为临时变量，以后遇到相同的表达式时，直接使用临时变量的值，避免重复计算。

公共表达式消除可以减少程序中的冗余计算，提高程序的执行效率。特别是在循环中或频繁执行的代码段中，如果能够识别和消除公共表达式，可以获得显著的性能提升。

## AI编译器的公共表达式消除

公共表达式是传统编译器常用的前端优化的一种，经过迁移也可以应用到深度学习编译器中。

AI 编译器中公共子表达式消除采取相同的思路，区别在于AI 编译器中子表达式是基于计算图或图层IR。通过在计算图中搜索相同结构的子图，简化计算图的结构，从而减少计算开销。

以tensorflow为例，给出AI编译器实现公共表达式消除的一种实现。

tensorflow会使用深度优先搜索遍历计算图。tensorflow会维护一个栈，栈中包含节点以及节点对应的两个状态visited和leave。visited表示这个节点是否被访问过了，leave表示该节点是否不会再次入栈。首先初始化栈，将计算图的源节点压入栈中，并将这些节点的visited和leave设置为false。接下来进行弹栈操作，直到栈为空。弹窗栈顶节点，判断栈顶节点的leave属性是否为false，如果为true，则执行相应的leave操作，将栈顶节点插入后续节点集中，开始下一轮的弹栈操作。如果为false，则判断visited属性是否为true，如果为true，说明该节点以及执行完成后续操作，开始下一轮的弹栈操作。如果为false，则将该节点的visited 和leave 都设置为 true，并将该栈顶节点重新压入栈中。获取到栈顶节点所有出边对应的visited为false的目标节点，并将这些节点按照id的大小进行排序，排序后依次压入栈中，接着继续弹栈操作，直达栈为空。当栈为空时，此时已经获得该计算图的后续节点集，将该节点集进行反向操作，就可以获得反向节点集。反向节点集的作用是为了确保当对某个节点进行操作时，该节点的依赖节点都已经被处理过了。

遍历反向后续节点集，需要注意的是，在这个过程中，程序只关注操作节点，所以需要跳过占位符、源节点和汇节点。对于某个节点n，获取其对应的hash值h。tensorflow对于hash值的计算采用混合哈希的计算模式，需要综合考虑节点的操作类型，输出节点的个数以及每个输出节点的类型，以及输入节点的一些信息。对于输入节点的处理比较复杂，在处理节点时，需要对输入节点进行分类，分为数据节点和控制依赖节点。遍历输入节点，生成数据节点集和控制依赖节点集。对于hash的处理只需要数据节点集，判断n的操作类型是否满足交换律，如果满足，则需要对数据节点集进行排序，消除输入顺序带来的影响。比如对于add操作，add(a,b)和add(b,a)是同一个操作。排序后，遍历数据节点集，使用每个节点的id以及这个节点对于n的输入索引分别进行混合hash计算。除了考虑这些因素，tensorflow还对几类节点做了进一步特定的hash混合计算，感兴趣的可以自行查阅相关代码。这样处理的目的是为了确保一个表达式对应一个hash值，达到检索公共表达式的目的。

公共子表达式候选集是一个map，它将hash值和节点对应起来。当计算出节点n的hash值后，判断这个hash值在公共子表达式候选集中是否有对应的值，如果没有则将该值设置为n。如果存在则需要判断节点n与已有的节点m是否是同一个节点，hash值已经做了初步的比较了，安全起见还需要判断n和m其他一些信息是否相同，比如属性，控制依赖等信息，确保n和m的相同性。

如果n和m相同，遍历n的输出边，将m节点和n的输出节点建立联系。完成后删除n。

以上就是tensorflow对于公共表达删除的处理。

## 本节视频

<html>
<iframe src="https:&as_wide=1&high_quality=1&danmaku=0&t=30&autoplay=0" width="100%" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>
</html>
